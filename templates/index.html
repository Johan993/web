{% extends "base.html" %}

{% block title %}Трекер привычек{% endblock %}

{% block content %}
  <section class="water-tracker mb-4">
    <h5>Трекер воды</h5>
    <div class="progress">
      <div class="progress-bar" role="progressbar"
           style="width: {{ (water_amount / water_goal * 100) | round }}%;"></div>
    </div>
    <small class="text-muted">{{ water_amount }} мл из {{ water_goal }} мл</small>
  </section>

  <section class="habits mb-5">
    <h5>Ваши привычки</h5>

    <form method="post" class="row g-2 mb-4">
      {{ habit_form.hidden_tag() }}
      <div class="col-auto flex-grow-1">
        {{ habit_form.name(class="form-control", placeholder="Название привычки") }}
      </div>
      <div class="col-auto">
        {{ habit_form.submit(class="btn btn-primary") }}
      </div>
    </form>

    {% if habits %}
      <div class="row gy-4">
        {% for habit, today_idx in habits %}
          <div class="col-lg-3 col-md-4">
            <div class="card habit-card h-100" data-today="{{ today_idx }}">
              <div class="card-header bg-dark text-white">{{ habit.name }}</div>
              <div class="habit-calendar p-3">
                {% for i in range(28) %}
                  {% set status = habit.days and habit.days[i] %}
                  {% if status %}
                  <span
                  class="me-1 mb-1 d-inline-block habit-day
                          {{ 'done' if status.status.value == 'done'
                           else 'skipped' if status.status.value == 'skipped'
                            else '' }}"
                  data-index="{{ i }}">
                  </span>
                {% else %}
                  <span class="me-1 mb-1 d-inline-block habit-day" data-index="{{ i }}"></span>
                {% endif %}
                {% endfor %}
              </div>
              <div class="card-body text-center">
                <form method="post"
                      action="{{ url_for('mark_habit', habit_id=habit.id) }}"
                      class="d-inline btn-action"
                      data-action="done">
                  <button class="btn btn-sm btn-outline-success">Выполнено</button>
                </form>
                <form method="post"
                      action="{{ url_for('mark_habit', habit_id=habit.id) }}"
                      class="d-inline ms-2 btn-action"
                      data-action="skip">
                  <button class="btn btn-sm btn-outline-secondary">Пропустить</button>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">У вас пока нет привычек. Добавьте первую выше!</p>
    {% endif %}
  </section>

  <script>
    document.querySelectorAll('.btn-action').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const card = this.closest('.habit-card');
        const todayIdx = +card.dataset.today;
        if (isNaN(todayIdx)) return this.submit();
        fetch(this.action, {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({action: this.dataset.action})
        }).then(response => {
          const cell = card.querySelector(`.habit-day[data-index="${todayIdx}"]`);
          if (cell) {
            cell.classList.toggle('done', this.dataset.action === 'done');
            cell.classList.toggle('skipped', this.dataset.action === 'skip');
          }
        }).catch(() => this.submit());
      });
    });
  </script>
{% endblock %}